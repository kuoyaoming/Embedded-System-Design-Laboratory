#include <stdint.h>
#include <stdio.h>
#include <string.h>
#include "hal.h"
#include "system_mt7687.h"
#include "top.h"
#include "hal_i2c.h"
#include "i2C.h"
#include "hal_i2c_master.h"

#define SeeedOLED_Address               0x3c
#define SeeedOLED_Command_Mode          0x80
#define SeeedOLED_Data_Mode             0x40
#define SeeedOLED_Display_Off_Cmd       0xAE
#define SeeedOLED_Display_On_Cmd        0xAF
#define SeeedOLED_Normal_Display_Cmd    0xA6

uint8_t font[][8] =
{
	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{0x00,0x00,0x5F,0x00,0x00,0x00,0x00,0x00},
	{0x00,0x00,0x07,0x00,0x07,0x00,0x00,0x00},
	{0x00,0x14,0x7F,0x14,0x7F,0x14,0x00,0x00},
	{0x00,0x24,0x2A,0x7F,0x2A,0x12,0x00,0x00},
	{0x00,0x23,0x13,0x08,0x64,0x62,0x00,0x00},
	{0x00,0x36,0x49,0x55,0x22,0x50,0x00,0x00},
	{0x00,0x00,0x05,0x03,0x00,0x00,0x00,0x00},
	{0x00,0x1C,0x22,0x41,0x00,0x00,0x00,0x00},
	{0x00,0x41,0x22,0x1C,0x00,0x00,0x00,0x00},
	{0x00,0x08,0x2A,0x1C,0x2A,0x08,0x00,0x00},
	{0x00,0x08,0x08,0x3E,0x08,0x08,0x00,0x00},
	{0x00,0xA0,0x60,0x00,0x00,0x00,0x00,0x00},
	{0x00,0x08,0x08,0x08,0x08,0x08,0x00,0x00},
	{0x00,0x60,0x60,0x00,0x00,0x00,0x00,0x00},
	{0x00,0x20,0x10,0x08,0x04,0x02,0x00,0x00},
	{0x00,0x3E,0x51,0x49,0x45,0x3E,0x00,0x00},
	{0x00,0x00,0x42,0x7F,0x40,0x00,0x00,0x00},
	{0x00,0x62,0x51,0x49,0x49,0x46,0x00,0x00},
	{0x00,0x22,0x41,0x49,0x49,0x36,0x00,0x00},
	{0x00,0x18,0x14,0x12,0x7F,0x10,0x00,0x00},
	{0x00,0x27,0x45,0x45,0x45,0x39,0x00,0x00},
	{0x00,0x3C,0x4A,0x49,0x49,0x30,0x00,0x00},
	{0x00,0x01,0x71,0x09,0x05,0x03,0x00,0x00},
	{0x00,0x36,0x49,0x49,0x49,0x36,0x00,0x00},
	{0x00,0x06,0x49,0x49,0x29,0x1E,0x00,0x00},
	{0x00,0x00,0x36,0x36,0x00,0x00,0x00,0x00},
	{0x00,0x00,0xAC,0x6C,0x00,0x00,0x00,0x00},
	{0x00,0x08,0x14,0x22,0x41,0x00,0x00,0x00},
	{0x00,0x14,0x14,0x14,0x14,0x14,0x00,0x00},
	{0x00,0x41,0x22,0x14,0x08,0x00,0x00,0x00},
	{0x00,0x02,0x01,0x51,0x09,0x06,0x00,0x00},
	{0x00,0x32,0x49,0x79,0x41,0x3E,0x00,0x00},
	{0x00,0x7E,0x09,0x09,0x09,0x7E,0x00,0x00},
	{0x00,0x7F,0x49,0x49,0x49,0x36,0x00,0x00},
	{0x00,0x3E,0x41,0x41,0x41,0x22,0x00,0x00},
	{0x00,0x7F,0x41,0x41,0x22,0x1C,0x00,0x00},
	{0x00,0x7F,0x49,0x49,0x49,0x41,0x00,0x00},
	{0x00,0x7F,0x09,0x09,0x09,0x01,0x00,0x00},
	{0x00,0x3E,0x41,0x41,0x51,0x72,0x00,0x00},
	{0x00,0x7F,0x08,0x08,0x08,0x7F,0x00,0x00},
	{0x00,0x41,0x7F,0x41,0x00,0x00,0x00,0x00},
	{0x00,0x20,0x40,0x41,0x3F,0x01,0x00,0x00},
	{0x00,0x7F,0x08,0x14,0x22,0x41,0x00,0x00},
	{0x00,0x7F,0x40,0x40,0x40,0x40,0x00,0x00},
	{0x00,0x7F,0x02,0x0C,0x02,0x7F,0x00,0x00},
	{0x00,0x7F,0x04,0x08,0x10,0x7F,0x00,0x00},
	{0x00,0x3E,0x41,0x41,0x41,0x3E,0x00,0x00},
	{0x00,0x7F,0x09,0x09,0x09,0x06,0x00,0x00},
	{0x00,0x3E,0x41,0x51,0x21,0x5E,0x00,0x00},
	{0x00,0x7F,0x09,0x19,0x29,0x46,0x00,0x00},
	{0x00,0x26,0x49,0x49,0x49,0x32,0x00,0x00},
	{0x00,0x01,0x01,0x7F,0x01,0x01,0x00,0x00},
	{0x00,0x3F,0x40,0x40,0x40,0x3F,0x00,0x00},
	{0x00,0x1F,0x20,0x40,0x20,0x1F,0x00,0x00},
	{0x00,0x3F,0x40,0x38,0x40,0x3F,0x00,0x00},
	{0x00,0x63,0x14,0x08,0x14,0x63,0x00,0x00},
	{0x00,0x03,0x04,0x78,0x04,0x03,0x00,0x00},
	{0x00,0x61,0x51,0x49,0x45,0x43,0x00,0x00},
	{0x00,0x7F,0x41,0x41,0x00,0x00,0x00,0x00},
	{0x00,0x02,0x04,0x08,0x10,0x20,0x00,0x00},
	{0x00,0x41,0x41,0x7F,0x00,0x00,0x00,0x00},
	{0x00,0x04,0x02,0x01,0x02,0x04,0x00,0x00},
	{0x00,0x80,0x80,0x80,0x80,0x80,0x00,0x00},
	{0x00,0x01,0x02,0x04,0x00,0x00,0x00,0x00},
	{0x00,0x20,0x54,0x54,0x54,0x78,0x00,0x00},
	{0x00,0x7F,0x48,0x44,0x44,0x38,0x00,0x00},
	{0x00,0x38,0x44,0x44,0x28,0x00,0x00,0x00},
	{0x00,0x38,0x44,0x44,0x48,0x7F,0x00,0x00},
	{0x00,0x38,0x54,0x54,0x54,0x18,0x00,0x00},
	{0x00,0x08,0x7E,0x09,0x02,0x00,0x00,0x00},
	{0x00,0x18,0xA4,0xA4,0xA4,0x7C,0x00,0x00},
	{0x00,0x7F,0x08,0x04,0x04,0x78,0x00,0x00},
	{0x00,0x00,0x7D,0x00,0x00,0x00,0x00,0x00},
	{0x00,0x80,0x84,0x7D,0x00,0x00,0x00,0x00},
	{0x00,0x7F,0x10,0x28,0x44,0x00,0x00,0x00},
	{0x00,0x41,0x7F,0x40,0x00,0x00,0x00,0x00},
	{0x00,0x7C,0x04,0x18,0x04,0x78,0x00,0x00},
	{0x00,0x7C,0x08,0x04,0x7C,0x00,0x00,0x00},
	{0x00,0x38,0x44,0x44,0x38,0x00,0x00,0x00},
	{0x00,0xFC,0x24,0x24,0x18,0x00,0x00,0x00},
	{0x00,0x18,0x24,0x24,0xFC,0x00,0x00,0x00},
	{0x00,0x00,0x7C,0x08,0x04,0x00,0x00,0x00},
	{0x00,0x48,0x54,0x54,0x24,0x00,0x00,0x00},
	{0x00,0x04,0x7F,0x44,0x00,0x00,0x00,0x00},
	{0x00,0x3C,0x40,0x40,0x7C,0x00,0x00,0x00},
	{0x00,0x1C,0x20,0x40,0x20,0x1C,0x00,0x00},
	{0x00,0x3C,0x40,0x30,0x40,0x3C,0x00,0x00},
	{0x00,0x44,0x28,0x10,0x28,0x44,0x00,0x00},
	{0x00,0x1C,0xA0,0xA0,0x7C,0x00,0x00,0x00},
	{0x00,0x44,0x64,0x54,0x4C,0x44,0x00,0x00},
	{0x00,0x08,0x36,0x41,0x00,0x00,0x00,0x00},
	{0x00,0x00,0x7F,0x00,0x00,0x00,0x00,0x00},
	{0x00,0x41,0x36,0x08,0x00,0x00,0x00,0x00},
	{0x00,0x02,0x01,0x01,0x02,0x01,0x00,0x00},
	{0x00,0x02,0x05,0x05,0x02,0x00,0x00,0x00}
};

#ifdef __GNUC_
int __io_putchar(int ch)
#else
int fputc(int ch, FILE *f)
#endif
{
	hal_uart_put_char(HAL_UART_0, ch);
	return ch;
}

static void plain_log_uart_init(void)
{
	hal_uart_config_t uart_config;
	/* Set Pinmux to UART */
	hal_pinmux_set_function(HAL_GPIO_0, HAL_GPIO_0_UART1_RTS_CM4);
	hal_pinmux_set_function(HAL_GPIO_1, HAL_GPIO_1_UART1_CTS_CM4);
	hal_pinmux_set_function(HAL_GPIO_2, HAL_GPIO_2_UART1_RX_CM4);
	hal_pinmux_set_function(HAL_GPIO_3, HAL_GPIO_3_UART1_TX_CM4);

	/* COM port settings */
	uart_config.baudrate = HAL_UART_BAUDRATE_115200;
	uart_config.word_length = HAL_UART_WORD_LENGTH_8;
	uart_config.stop_bit = HAL_UART_STOP_BIT_1;
	uart_config.parity = HAL_UART_PARITY_NONE;
	hal_uart_init(HAL_UART_0, &uart_config);
}

static void SystemClock_Config(void)
{
	top_xtal_init();
}

static void prvSetupHardware(void)
{
	plain_log_uart_init();
}
//OLED CPP======================================================
void OLED_ini(void);
void sendCommand(uint8_t Command);
void sendData(uint8_t data);
void putChar(unsigned char C);
void putString(const char *String);
void Display_init(void);
void setPageMode(void);
void setTextXY(unsigned char Row, unsigned char Column);
unsigned char putNumber(long long_num);
unsigned char putFloat(float floatNumber, unsigned char decimal);
void clearDisplay(void);

void OLED_ini(void)
{
	hal_i2c_config_t i2c_config;
	i2c_config.frequency = HAL_I2C_FREQUENCY_400K;

	hal_gpio_init(HAL_GPIO_27);
	hal_gpio_init(HAL_GPIO_28);
	hal_pinmux_set_function(HAL_GPIO_27, HAL_GPIO_27_I2C1_CLK);
	hal_pinmux_set_function(HAL_GPIO_28, HAL_GPIO_28_I2C1_DATA);
	hal_i2c_master_init(HAL_I2C_MASTER_0, &i2c_config);
	hal_adc_init();
}

void sendCommand(uint8_t Command)
{
	uint8_t i2c_send_data[2] = { SeeedOLED_Command_Mode, Command };
	hal_i2c_master_send_polling(HAL_I2C_MASTER_0, SeeedOLED_Address, i2c_send_data, 2);
}

void sendData(uint8_t data)
{
	uint8_t i2c_send_data[2] = { SeeedOLED_Data_Mode, data };
	hal_i2c_master_send_polling(HAL_I2C_MASTER_0, SeeedOLED_Address, i2c_send_data, 2);
}

void putChar(unsigned char C)
{
	unsigned char i = 0;
	for (i = 0; i < 8; i++)
	{
		sendData(font[C - 32][i]);
	}
}

void putString(const char *String)
{
	unsigned char i = 0;
	while (String[i]) {
		putChar(String[i]);
		i++;
	}
}

void Display_init(void)
{
	sendCommand(SeeedOLED_Display_Off_Cmd);
	hal_gpt_delay_ms(5);
	sendCommand(SeeedOLED_Display_On_Cmd);
	hal_gpt_delay_ms(5);
	sendCommand(SeeedOLED_Normal_Display_Cmd);
}

void setPageMode(void)
{
	sendCommand(0x20);          //set addressing mode
	sendCommand(0x02);          //set page addressing mode
}

void setTextXY(unsigned char Row, unsigned char Column)
{
	sendCommand(0xB0 + Row);            //set page address
	sendCommand(0x00 + (8 * Column & 0x0F));  //set column lower address
	sendCommand(0x10 + ((8 * Column >> 4) & 0x0F));   //set column higher address
}

unsigned char putNumber(long long_num)
{
	unsigned char char_buffer[10] = "";
	unsigned char i = 0;
	unsigned char f = 0;

	if (long_num < 0)
	{
		f = 1;
		putChar('-');
		long_num = -long_num;
	}
	else if (long_num == 0)
	{
		f = 1;
		putChar('0');
		return f;
	}

	while (long_num > 0)
	{
		char_buffer[i++] = long_num % 10;
		long_num /= 10;
	}

	f = f + i;
	for (; i > 0; i--)
	{
		putChar('0' + char_buffer[i - 1]);
	}
	return f;

}

unsigned char putFloat(float floatNumber, unsigned char decimal)
{
	unsigned int temp = 0;
	float rounding = 0.5;
	unsigned char f = 0;
	if (floatNumber < 0)
	{
		putString("-");
		floatNumber = -floatNumber;
		f += 1;
	}
	for (unsigned char i = 0; i < decimal; ++i)
	{
		rounding /= 10;
	}
	floatNumber += rounding;
	temp = floatNumber;
	f += putNumber(temp);

	return f;
}

void clearDisplay(void)
{
	unsigned char i, j;
	sendCommand(SeeedOLED_Display_Off_Cmd);   //display off
	for (j = 0; j < 8; j++)
	{
		setTextXY(j, 0);

		for (i = 0; i < 16; i++)  //clear all columns
		{
			putChar(' ');
		}

	}
	sendCommand(SeeedOLED_Display_On_Cmd);    //display on
	setTextXY(0, 0);
}


//DHT CPP===========================================================

void DHT_ini(void);
float readTemperature(void);
float readHumidity(void);
boolean read(void);

uint8_t data[6];
boolean firstreading = true;

void DHT_ini(void)
{
	hal_gpio_init(HAL_GPIO_0);
	hal_pinmux_set_function(HAL_GPIO_0, 8);
	hal_gpio_set_direction(HAL_GPIO_0, HAL_GPIO_DIRECTION_OUTPUT);
	hal_gpio_set_output(HAL_GPIO_0, HAL_GPIO_DATA_HIGH);
}

float readTemperature(void)
{
	float f;
	if (read())
	{
		f = data[2] & 0x7F;
		f *= 256;
		f += data[3];
		f /= 10;
		if (data[2] & 0x80)
			f *= -1;
	}
	return f;
}

float readHumidity(void)
{
	float f;
	if (read())
	{
		f = data[0];
		f *= 256;
		f += data[1];
		f /= 10;
	}
	return f;
}

boolean read(void)
{
	uint32_t currenttime, _lastreadtime, duration_count;
	uint8_t laststate = 0xFF;
	uint8_t counter = 0;
	uint8_t j = 0, i;
	hal_gpio_data_t stat;

	hal_gpio_set_output(HAL_GPIO_0, HAL_GPIO_DATA_HIGH);
	hal_gpt_delay_ms(250);
	hal_gpt_get_free_run_count(HAL_GPT_CLOCK_SOURCE_1M, &currenttime);

	if (currenttime < _lastreadtime)
	{
		_lastreadtime = 0;
	}
	hal_gpt_get_duration_count(currenttime, _lastreadtime, &duration_count);

	if (!firstreading && (duration_count < 2000000))
	{
		return true;
	}
	firstreading = false;

	hal_gpt_get_free_run_count(HAL_GPT_CLOCK_SOURCE_1M, &_lastreadtime);

	data[0] = data[1] = data[2] = data[3] = data[4] = 0;

	hal_gpio_set_direction(HAL_GPIO_0, HAL_GPIO_DIRECTION_OUTPUT);
	hal_gpio_set_output(HAL_GPIO_0, HAL_GPIO_DATA_LOW);
	hal_gpt_delay_ms(20);
	hal_gpio_set_output(HAL_GPIO_0, HAL_GPIO_DATA_HIGH);
	hal_gpt_delay_us(40);
	hal_gpio_set_direction(HAL_GPIO_0, HAL_GPIO_DIRECTION_INPUT);

	for (i = 0; i < 85; i++)
	{
		counter = 0;
		hal_gpio_get_input(HAL_GPIO_0, &stat);
		while (stat == laststate)
		{
			counter++;
			hal_gpt_delay_us(5);

			if (counter == 255)
			{
				break;
			}
		}
		hal_gpio_get_input(HAL_GPIO_0, &stat);
		laststate = stat;

		if (counter == 255) break;

		if ((i >= 4) && (i % 2 == 0))
		{
			data[j / 8] <<= 1;
			if (counter > 6)
				data[j / 8] |= 1;
			j++;
		}
	}
	if ((j >= 40) && (data[4] == ((data[0] + data[1] + data[2] + data[3]) & 0xFF)))
	{
		return true;
	}

	return false;
}

int main(void)
{
	SystemClock_Config();
	prvSetupHardware();
	__enable_irq();
	__enable_fault_irq();

	DHT_ini();
	OLED_ini();
	Display_init();

	setPageMode();
	clearDisplay();
	hal_gpt_delay_ms(2000);

	setTextXY(0, 0);
	putString("     NTUST      ");
	setTextXY(1, 0);
	putString("Temperature=");
	setTextXY(2, 0);
	putString("Humidity = ");

	while (1)
	{
		float h = readHumidity();
		float t = readTemperature();

		setTextXY(1, 12);
		putString("    ");
		setTextXY(1, 12);
		putFloat(t, 1);

		setTextXY(2, 11);
		putString("    ");
		setTextXY(2, 11);
		putFloat(h, 1);

		printf("Temperature=%.1f , Humidity=%.1f \r\n", t, h);
		hal_gpt_delay_ms(2000);
	}
}
