#include <stdint.h>
#include <stdio.h>
#include <string.h>
#include <stdint.h>

#include "hal.h"
#include "top.h"
#include "hal_i2c.h"
#include "hal_i2c_master.h"

uint8_t font[][8] =
{
  {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
  {0x00,0x00,0x5F,0x00,0x00,0x00,0x00,0x00},
  {0x00,0x00,0x07,0x00,0x07,0x00,0x00,0x00},
  {0x00,0x14,0x7F,0x14,0x7F,0x14,0x00,0x00},
  {0x00,0x24,0x2A,0x7F,0x2A,0x12,0x00,0x00},
  {0x00,0x23,0x13,0x08,0x64,0x62,0x00,0x00},
  {0x00,0x36,0x49,0x55,0x22,0x50,0x00,0x00},
  {0x00,0x00,0x05,0x03,0x00,0x00,0x00,0x00},
  {0x00,0x1C,0x22,0x41,0x00,0x00,0x00,0x00},
  {0x00,0x41,0x22,0x1C,0x00,0x00,0x00,0x00},
  {0x00,0x08,0x2A,0x1C,0x2A,0x08,0x00,0x00},
  {0x00,0x08,0x08,0x3E,0x08,0x08,0x00,0x00},
  {0x00,0xA0,0x60,0x00,0x00,0x00,0x00,0x00},
  {0x00,0x08,0x08,0x08,0x08,0x08,0x00,0x00},
  {0x00,0x60,0x60,0x00,0x00,0x00,0x00,0x00},
  {0x00,0x20,0x10,0x08,0x04,0x02,0x00,0x00},
  {0x00,0x3E,0x51,0x49,0x45,0x3E,0x00,0x00},
  {0x00,0x00,0x42,0x7F,0x40,0x00,0x00,0x00},
  {0x00,0x62,0x51,0x49,0x49,0x46,0x00,0x00},
  {0x00,0x22,0x41,0x49,0x49,0x36,0x00,0x00},
  {0x00,0x18,0x14,0x12,0x7F,0x10,0x00,0x00},
  {0x00,0x27,0x45,0x45,0x45,0x39,0x00,0x00},
  {0x00,0x3C,0x4A,0x49,0x49,0x30,0x00,0x00},
  {0x00,0x01,0x71,0x09,0x05,0x03,0x00,0x00},
  {0x00,0x36,0x49,0x49,0x49,0x36,0x00,0x00},
  {0x00,0x06,0x49,0x49,0x29,0x1E,0x00,0x00},
  {0x00,0x00,0x36,0x36,0x00,0x00,0x00,0x00},
  {0x00,0x00,0xAC,0x6C,0x00,0x00,0x00,0x00},
  {0x00,0x08,0x14,0x22,0x41,0x00,0x00,0x00},
  {0x00,0x14,0x14,0x14,0x14,0x14,0x00,0x00},
  {0x00,0x41,0x22,0x14,0x08,0x00,0x00,0x00},
  {0x00,0x02,0x01,0x51,0x09,0x06,0x00,0x00},
  {0x00,0x32,0x49,0x79,0x41,0x3E,0x00,0x00},
  {0x00,0x7E,0x09,0x09,0x09,0x7E,0x00,0x00},
  {0x00,0x7F,0x49,0x49,0x49,0x36,0x00,0x00},
  {0x00,0x3E,0x41,0x41,0x41,0x22,0x00,0x00},
  {0x00,0x7F,0x41,0x41,0x22,0x1C,0x00,0x00},
  {0x00,0x7F,0x49,0x49,0x49,0x41,0x00,0x00},
  {0x00,0x7F,0x09,0x09,0x09,0x01,0x00,0x00},
  {0x00,0x3E,0x41,0x41,0x51,0x72,0x00,0x00},
  {0x00,0x7F,0x08,0x08,0x08,0x7F,0x00,0x00},
  {0x00,0x41,0x7F,0x41,0x00,0x00,0x00,0x00},
  {0x00,0x20,0x40,0x41,0x3F,0x01,0x00,0x00},
  {0x00,0x7F,0x08,0x14,0x22,0x41,0x00,0x00},
  {0x00,0x7F,0x40,0x40,0x40,0x40,0x00,0x00},
  {0x00,0x7F,0x02,0x0C,0x02,0x7F,0x00,0x00},
  {0x00,0x7F,0x04,0x08,0x10,0x7F,0x00,0x00},
  {0x00,0x3E,0x41,0x41,0x41,0x3E,0x00,0x00},
  {0x00,0x7F,0x09,0x09,0x09,0x06,0x00,0x00},
  {0x00,0x3E,0x41,0x51,0x21,0x5E,0x00,0x00},
  {0x00,0x7F,0x09,0x19,0x29,0x46,0x00,0x00},
  {0x00,0x26,0x49,0x49,0x49,0x32,0x00,0x00},
  {0x00,0x01,0x01,0x7F,0x01,0x01,0x00,0x00},
  {0x00,0x3F,0x40,0x40,0x40,0x3F,0x00,0x00},
  {0x00,0x1F,0x20,0x40,0x20,0x1F,0x00,0x00},
  {0x00,0x3F,0x40,0x38,0x40,0x3F,0x00,0x00},
  {0x00,0x63,0x14,0x08,0x14,0x63,0x00,0x00},
  {0x00,0x03,0x04,0x78,0x04,0x03,0x00,0x00},
  {0x00,0x61,0x51,0x49,0x45,0x43,0x00,0x00},
  {0x00,0x7F,0x41,0x41,0x00,0x00,0x00,0x00},
  {0x00,0x02,0x04,0x08,0x10,0x20,0x00,0x00},
  {0x00,0x41,0x41,0x7F,0x00,0x00,0x00,0x00},
  {0x00,0x04,0x02,0x01,0x02,0x04,0x00,0x00},
  {0x00,0x80,0x80,0x80,0x80,0x80,0x00,0x00},
  {0x00,0x01,0x02,0x04,0x00,0x00,0x00,0x00},
  {0x00,0x20,0x54,0x54,0x54,0x78,0x00,0x00},
  {0x00,0x7F,0x48,0x44,0x44,0x38,0x00,0x00},
  {0x00,0x38,0x44,0x44,0x28,0x00,0x00,0x00},
  {0x00,0x38,0x44,0x44,0x48,0x7F,0x00,0x00},
  {0x00,0x38,0x54,0x54,0x54,0x18,0x00,0x00},
  {0x00,0x08,0x7E,0x09,0x02,0x00,0x00,0x00},
  {0x00,0x18,0xA4,0xA4,0xA4,0x7C,0x00,0x00},
  {0x00,0x7F,0x08,0x04,0x04,0x78,0x00,0x00},
  {0x00,0x00,0x7D,0x00,0x00,0x00,0x00,0x00},
  {0x00,0x80,0x84,0x7D,0x00,0x00,0x00,0x00},
  {0x00,0x7F,0x10,0x28,0x44,0x00,0x00,0x00},
  {0x00,0x41,0x7F,0x40,0x00,0x00,0x00,0x00},
  {0x00,0x7C,0x04,0x18,0x04,0x78,0x00,0x00},
  {0x00,0x7C,0x08,0x04,0x7C,0x00,0x00,0x00},
  {0x00,0x38,0x44,0x44,0x38,0x00,0x00,0x00},
  {0x00,0xFC,0x24,0x24,0x18,0x00,0x00,0x00},
  {0x00,0x18,0x24,0x24,0xFC,0x00,0x00,0x00},
  {0x00,0x00,0x7C,0x08,0x04,0x00,0x00,0x00},
  {0x00,0x48,0x54,0x54,0x24,0x00,0x00,0x00},
  {0x00,0x04,0x7F,0x44,0x00,0x00,0x00,0x00},
  {0x00,0x3C,0x40,0x40,0x7C,0x00,0x00,0x00},
  {0x00,0x1C,0x20,0x40,0x20,0x1C,0x00,0x00},
  {0x00,0x3C,0x40,0x30,0x40,0x3C,0x00,0x00},
  {0x00,0x44,0x28,0x10,0x28,0x44,0x00,0x00},
  {0x00,0x1C,0xA0,0xA0,0x7C,0x00,0x00,0x00},
  {0x00,0x44,0x64,0x54,0x4C,0x44,0x00,0x00},
  {0x00,0x08,0x36,0x41,0x00,0x00,0x00,0x00},
  {0x00,0x00,0x7F,0x00,0x00,0x00,0x00,0x00},
  {0x00,0x41,0x36,0x08,0x00,0x00,0x00,0x00},
  {0x00,0x02,0x01,0x01,0x02,0x01,0x00,0x00},
  {0x00,0x02,0x05,0x05,0x02,0x00,0x00,0x00}
};

#ifdef __GNUC_
int __io_putchar(int ch)
#else
int fputc(int ch, FILE *f)
#endif
{
	hal_uart_put_char(HAL_UART_0, ch);
	return ch;
}

static void plain_log_uart_init(void)
{
	hal_uart_config_t uart_config;
	/* Set Pinmux to UART */
	hal_pinmux_set_function(HAL_GPIO_0, HAL_GPIO_0_UART1_RTS_CM4);
	hal_pinmux_set_function(HAL_GPIO_1, HAL_GPIO_1_UART1_CTS_CM4);
	hal_pinmux_set_function(HAL_GPIO_2, HAL_GPIO_2_UART1_RX_CM4);
	hal_pinmux_set_function(HAL_GPIO_3, HAL_GPIO_3_UART1_TX_CM4);

	/* COM port settings */
	uart_config.baudrate = HAL_UART_BAUDRATE_115200;
	uart_config.word_length = HAL_UART_WORD_LENGTH_8;
	uart_config.stop_bit = HAL_UART_STOP_BIT_1;
	uart_config.parity = HAL_UART_PARITY_NONE;
	hal_uart_init(HAL_UART_0, &uart_config);
}

static void SystemClock_Config(void)
{
	top_xtal_init();
}

static void prvSetupHardware(void)
{
	plain_log_uart_init();
}

uint8_t buffer[8];
float ax,ay,az,gx,gy,gz,mx,my,mz,tp;
int16_t ax_d,ay_d,az_d,gx_d,gy_d,gz_d,mx_d,my_d,mz_d,tp_d;

void i2c_init(void);
void i2c_send(uint8_t, uint8_t, uint8_t);
void i2c_send_to_receive(uint8_t, uint8_t, uint8_t);
void putChar(unsigned char C);
void putString(const char *String);
void Display_init(void);
void setPageMode(void);
void setTextXY(uint8_t, uint8_t);
uint8_t putNumber(int32_t);
unsigned char putFloat(float floatNumber, unsigned char decimal);
void clearDisplay(void);
void IMU_ini(void);
void getAllData(void);
void ConversionData(void);

//=================================================================================
//=================================================================================
int main(void)
{
	SystemClock_Config();
	prvSetupHardware();
	__enable_irq();
	__enable_fault_irq();

	i2c_init();
	Display_init();
	IMU_ini();

	setPageMode();
	clearDisplay();
	hal_gpt_delay_ms(2000);
	setTextXY(0, 0);
	putString("     NTUST      ");
	setTextXY(1, 0);
	putString("Temperature=");
	
	
	

	while (1)
	{
		getAllData();
		ConversionData();
		
		setTextXY(1, 12);putString("    ");
		setTextXY(1, 12);putFloat(tp, 1);

		setTextXY(2, 0);
		putString("G:");
		putFloat(gx, 1);
		putString(" ");putFloat(gy, 1);
		putString(" ");putFloat(gz, 1);

		setTextXY(3, 0);
		putString("A:");
		putFloat(ax, 1);
		putString(" ");putFloat(ay, 1);
		putString(" ");putFloat(az, 1);

		setTextXY(4, 0);
		putString("M:");
		putFloat(mx, 1);
		putString(" ");putFloat(my, 1);
		putString(" ");putFloat(mz, 1);

		printf("Temperature=%5.1f ", tp);
		printf("G:%5.1f %5.1f %5.1f ,", gx, gy, gz);
		printf("A:%5.1f %5.1f %5.1f ,", ax, ay, az);
		printf("M:%5.1f %5.1f %5.1f \r\n",mx, my, mz);

		hal_gpt_delay_ms(100);
	}
}

//=================================================================================
//=================================================================================
void i2c_init(void)
{
	hal_gpio_init(HAL_GPIO_27);
	hal_gpio_init(HAL_GPIO_28);
	hal_pinmux_set_function(HAL_GPIO_27, HAL_GPIO_27_I2C1_CLK);
	hal_pinmux_set_function(HAL_GPIO_28, HAL_GPIO_28_I2C1_DATA);
}

void i2c_send(uint8_t address, uint8_t data1, uint8_t data2)
{
	hal_i2c_config_t i2c_config;
	i2c_config.frequency = HAL_I2C_FREQUENCY_400K;
	hal_i2c_master_init(HAL_I2C_MASTER_0, &i2c_config);
	uint8_t data[2] = { data1, data2 };
	hal_i2c_master_send_polling(HAL_I2C_MASTER_0, address, data, 2);
	hal_i2c_master_deinit(HAL_I2C_MASTER_0);
}

void i2c_send_to_receive(uint8_t address, uint8_t Data, uint8_t receive_length)
{
	hal_i2c_config_t i2c_config;
	i2c_config.frequency = HAL_I2C_FREQUENCY_400K;
	hal_i2c_send_to_receive_config_t i2c_send_to_receive_config;
	i2c_send_to_receive_config.slave_address = address;
	uint8_t send_data[1] = { Data };
	i2c_send_to_receive_config.send_data = send_data;
	i2c_send_to_receive_config.send_length = 1;
	i2c_send_to_receive_config.receive_buffer = buffer;
	i2c_send_to_receive_config.receive_length = receive_length;
	hal_i2c_master_init(HAL_I2C_MASTER_0, &i2c_config);
	hal_i2c_master_send_to_receive_polling(HAL_I2C_MASTER_0, &i2c_send_to_receive_config);
	hal_i2c_master_deinit(HAL_I2C_MASTER_0);
}

//=================================================================================
//=================================================================================

void putChar(unsigned char C)
{
	unsigned char i = 0;
	for (i = 0; i < 8; i++)
	{
		i2c_send(0x3c, 0x40, font[C - 32][i]);
	}
}

void putString(const char *String)
{
	unsigned char i = 0;
	while (String[i]) {
		putChar(String[i]);
		i++;
	}
}

void Display_init(void)
{
	i2c_send(0x3c, 0x80, 0xAE);
	hal_gpt_delay_ms(5);
	i2c_send(0x3c, 0x80, 0xAF);
	hal_gpt_delay_ms(5);
	i2c_send(0x3c, 0x80, 0xA6);
}

void setPageMode(void)
{
	i2c_send(0x3c, 0x80, 0x20);	//set addressing mode
	i2c_send(0x3c, 0x80, 0x02);	//set page addressing mode
}

void setTextXY(uint8_t Row, uint8_t Column)
{
	i2c_send(0x3c, 0x80, 0xB0 + Row);							//set page address
	i2c_send(0x3c, 0x80, 0x00 + (8 * Column & 0x0F));			//set column lower address
	i2c_send(0x3c, 0x80, 0x10 + ((8 * Column >> 4) & 0x0F));	//set column higher address
}

uint8_t putNumber(int32_t int32_t_num)
{
	uint8_t char_buffer[10] = "";
	uint8_t i = 0;
	uint8_t f = 0;

	if (int32_t_num < 0)
	{
		f = 1;
		putChar('-');
		int32_t_num = -int32_t_num;
	}
	else if (int32_t_num == 0)
	{
		f = 1;
		putChar('0');
		return f;
	}

	while (int32_t_num > 0)
	{
		char_buffer[i++] = int32_t_num % 10;
		int32_t_num /= 10;
	}

	f = f + i;
	for (; i > 0; i--)
	{
		putChar('0' + char_buffer[i - 1]);
	}
	return f;

}

unsigned char putFloat(float floatNumber, unsigned char decimal)
{
	unsigned int temp = 0;
	float decy = 0.0;
	float rounding = 0.5;
	unsigned char f = 0;
	if (floatNumber < 0.0f)
	{
		putString("-");
		floatNumber = -floatNumber;
		f += 1;
	}
	for (unsigned char i = 0; i < decimal; ++i)
	{
		rounding /= 10.0f;
	}
	floatNumber += rounding;

	temp = floatNumber;
	f += putNumber(temp);
	if (decimal > 0)
	{
		putChar('.');
		f += 1;
	}
	decy = floatNumber - temp;//decimal part,
	for (unsigned char i = 0; i < decimal; i++)//4
	{
		decy *= 10;// for the next decimal
		temp = decy;//get the decimal
		putNumber(temp);
		decy -= temp;
	}
	f += decimal;
	return f;
}
void clearDisplay(void)
{
	uint8_t i, j;
	i2c_send(0x3c, 0x80, 0xAE);	//display off
	for (j = 0; j < 8; j++)
	{
		setTextXY(j, 0);
		{
			for (i = 0; i < 16; i++)			//clear all columns
			{
				putChar(' ');
			}
		}
	}
	i2c_send(0x3c, 0x80, 0xAF);	//display on
	setTextXY(0, 0);
}

//=================================================================================
//=================================================================================

#define	IMU_address	0x68
#define	IMU_mag_address	0x0C

void IMU_ini(void)
{
	i2c_send(IMU_address, 0x6B, 0x01);
	i2c_send(IMU_address, 0x1C, 0x08);//set Accel Full Scale Select: Â±4g (01)
	i2c_send(IMU_address, 0x1D, 0x05);
	i2c_send(IMU_address, 0x1B, 0x08);//set Gyro Full Scale Select: +500dps (01)
	i2c_send(IMU_address, 0x1A, 0x05);
}

void getAllData(void)
{
	for (uint8_t i = 0; i < 8; i++)buffer[i] = 0;
	hal_gpt_delay_ms(10);
	i2c_send_to_receive(IMU_address, 0x3B, 6);
	ax_d = (((int16_t)buffer[0]) << 8) | buffer[1];//ax
	ay_d = (((int16_t)buffer[2]) << 8) | buffer[3];//ay
	az_d = (((int16_t)buffer[4]) << 8) | buffer[5];//az

	for (uint8_t i = 0; i < 8; i++)buffer[i] = 0;
	hal_gpt_delay_ms(10);
	i2c_send_to_receive(IMU_address, 0x41, 2);
	tp_d = (((int16_t)buffer[0]) << 8) | buffer[1];//temperature

	for (uint8_t i = 0; i < 8; i++)buffer[i] = 0;
	hal_gpt_delay_ms(10);
	i2c_send_to_receive(IMU_address, 0x43, 6);
	gx_d = (((int16_t)buffer[0]) << 8) | buffer[1];//gx
	gy_d = (((int16_t)buffer[2]) << 8) | buffer[3];//gy
	gz_d = (((int16_t)buffer[4]) << 8) | buffer[5];//gz

	for (uint8_t i = 0; i < 8; i++)buffer[i] = 0;
	hal_gpt_delay_ms(10);
	i2c_send(IMU_address, 0x37, 0x02);
	hal_gpt_delay_ms(10);
	i2c_send(IMU_mag_address, 0x0A, 0x01);
	hal_gpt_delay_ms(10);
	i2c_send_to_receive(IMU_mag_address, 0x03, 6);
	mx_d = (((int16_t)buffer[1]) << 8) | buffer[0];//mx
	my_d = (((int16_t)buffer[3]) << 8) | buffer[2];//my
	mz_d = (((int16_t)buffer[5]) << 8) | buffer[4];//mz
}

void ConversionData(void)
{
	ax = (float)ax_d / 8192.0f;
	ay = (float)ay_d / 8192.0f;
	az = (float)az_d / 8192.0f;
	gx = (float)gx_d / 65.536f;
	gy = (float)gy_d / 65.536f;
	gz = (float)gz_d / 65.536f;
	mx = (float)mx_d * 0.5859f;
	my = (float)my_d * 0.5859f;
	mz = (float)mz_d * 0.5859f;
	tp = (float)((tp_d - 21) / 333.87f) + 13;
}
